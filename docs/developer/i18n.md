# Internationalization (i18n)

## Overview

This app uses [Lingui](https://lingui.dev/) for internationalization. All user-facing strings, including native menus, are translated from a single source of truth using compile-time message extraction and ICU MessageFormat.

### Key Design Decisions

- **Lingui**: Modern i18n library with compile-time extraction, ICU MessageFormat, and 25x smaller bundle than react-i18next
- **PO translation files**: Standard gettext Portable Object format in `/src/locales/{locale}/`
- **Source text as keys**: Use actual text as keys (`_(msg`Save Changes`)`) instead of string IDs
- **JavaScript-based native menus**: Menus are built from JavaScript to use the same translation system
- **RTL support**: CSS uses logical properties for automatic RTL layout
- **Pure Lingui pattern**: Messages defined inline using `msg` macro at point of use

## Architecture

```
/src/locales/
├── en/
│   ├── messages.po       # English translations (source)
│   └── messages.ts       # Compiled messages for runtime
├── zh-CN/
│   ├── messages.po       # Chinese Simplified translations
│   └── messages.ts
├── zh-TW/
│   ├── messages.po       # Chinese Traditional translations
│   └── messages.ts
├── ja/
│   ├── messages.po       # Japanese translations
│   └── messages.ts
└── ko/
    ├── messages.po       # Korean translations
    └── messages.ts

/src/i18n/
├── config.ts            # Lingui i18n configuration
├── language-init.ts     # System locale detection
└── index.ts             # Exports

lingui.config.ts          # Lingui CLI configuration
```

## Current Setup

- **Library:** Lingui v5 with SWC compiler
- **Locales:** English (en), Chinese Simplified (zh-CN), Chinese Traditional (zh-TW), Japanese (ja), Korean (ko)
- **Language switching:** Runtime locale detection with system locale fallback
- **RTL Support:** Automatic `dir` and `lang` attribute updates on HTML element
- **Bundle size:** 25x smaller than react-i18next
- **Pattern:** Pure inline `msg` macro usage

## Quick Start

### Adding Translatable Strings

```typescript
import { msg } from '@lingui/core/macro';
import { useLingui } from '@lingui/react';

function MyComponent() {
  const { _ } = useLingui();

  return (
    <div>
      <h1>{_(msg`My Feature`)}</h1>
      <p>{_(msg`This is my feature description`)}</p>
      <button>{_(msg`Save Changes`)}</button>
    </div>
  );
}
```

### Extracting Messages

```bash
bun run i18n:extract  # Extract messages to PO files
bun run i18n:compile  # Compile PO files to TS for runtime
```

The extraction automatically creates/updates PO files with your messages. Translate them in the `.po` files, then compile.

## Message Types

### Static Text

```typescript
_(msg`Hello World`)
```

### Interpolation (ICU MessageFormat)

```typescript
// In component
_(msg`About ${appName}`)

// In PO file
msgid "About {appName}"
msgstr "关于 {appName}"
```

### Plurals

```typescript
import { plural } from '@lingui/core/macro';

function ItemCount({ count }: { count: number }) {
  const { _ } = useLingui();

  return (
    <p>
      {_(msg`You have ${plural(count, {
        one: '# item',
        other: '# items'
      })} in your cart`)}
    </p>
  );
}
```

### Rich Text with JSX

```typescript
import { Trans } from '@lingui/react/macro';

<Trans>
  Hello <strong>{name}</strong>, you have <Count count={5} /> messages
</Trans>
```

## Usage Patterns

### React Components

**Recommended Approach:**

```typescript
import { msg } from '@lingui/core/macro';
import { useLingui } from '@lingui/react';

function PreferencesDialog() {
  const { _ } = useLingui();

  return (
    <div>
      <h1>{_(msg`Preferences`)}</h1>
      <p>{_(msg`Configure your application settings`)}</p>
    </div>
  );
}
```

### Command Definitions

```typescript
import { msg } from "@lingui/core/macro";
import type { AppCommand } from "@/lib/commands/types";

export const navigationCommands: AppCommand[] = [
  {
    id: "show-sidebar",
    label: msg`Show Sidebar`,
    description: msg`Show the application sidebar`,
    execute: () => {
      // implementation
    },
  },
];
```

### Non-React Code

For menus, notifications, and other non-React contexts, bind i18n and use msg macro:

```typescript
import { msg } from '@lingui/core/macro';
import { i18n } from '@lingui/core';

const _ = i18n._.bind(i18n);
const text = _(msg`Save Changes`);
```

#### Using Lingui in Menus

```typescript
import { msg } from '@lingui/core/macro';
import { i18n } from '@lingui/core';

export async function buildAppMenu(): Promise<Menu> {
  const _ = i18n._.bind(i18n);

  const myItem = await MenuItem.new({
    id: 'my-action',
    text: _(msg`My Action`),
    action: handleMyAction,
  });

  // ... add to submenu
}
```

#### Automatic Menu Rebuild

```typescript
// In /src/lib/menu.ts
export function setupMenuLanguageListener(): () => void {
  const handler = async () => {
    await buildAppMenu();
  };

  const unsubscribe = i18n.on('change', handler);
  return () => {
    if (unsubscribe) unsubscribe();
  };
}
```

## Configuration

### lingui.config.ts

```typescript
export default defineConfig({
  sourceLocale: 'en',
  locales: ['en', 'zh-CN', 'zh-TW', 'ja', 'ko'],
  catalogs: [
    {
      path: 'src/locales/{locale}/messages',
      include: ['src/'],
      exclude: ['**/node_modules/**'],
    },
  ],
  format: 'po',
  orderBy: 'messageId',
  compilerBabelOptions: {
    minified: false,
    sourceMaps: false,
  },
});
```

### src/i18n/config.ts

```typescript
import { i18n } from '@lingui/core';

const rtlLanguages = ['he', 'fa', 'ur'];

function onLocaleChange(locale: string) {
  const dir = rtlLanguages.includes(locale) ? 'rtl' : 'ltr';
  document.documentElement.dir = dir;
  document.documentElement.lang = locale;
}

async function loadAndActivate(locale: string): Promise<void> {
  const { messages } = await import(`../locales/${locale}/messages.ts`);
  i18n.loadAndActivate({ locale, messages });
  onLocaleChange(locale);
}

export const availableLanguages = ['en', 'zh-CN', 'zh-TW', 'ja', 'ko'];
export { i18n, loadAndActivate };
```

## Extraction Workflow

### Step 1: Add Messages to Code

```typescript
// Use msg macro anywhere you need messages
_(msg`New Feature String`)
```

### Step 2: Extract Messages

```bash
bun run i18n:extract --clean
```

This creates/updates PO files with your new messages:

```
Catalog statistics for src/locales/{locale}/messages:
┌─────────────┬─────────────┬─────────┐
│ Language    │ Total count │ Missing │
├─────────────┼─────────────┼─────────┤
│ en (source) │     97      │    -    │
│ zh-CN       │     97      │    1    │  ← Translate this!
│ ja          │     97      │    0    │
└─────────────┴─────────────┴─────────┘
```

### Step 3: Translate

Open `src/locales/zh-CN/messages.po` and translate missing strings:

```po
msgid "New Feature String"
msgstr "新功能字符串"
```

### Step 4: Compile

```bash
bun run i18n:compile
```

This compiles PO files to TypeScript for runtime use.

## Translation Workflow

1. **Development** - Add `msg` macros inline
2. **Extract** - `bun run i18n:extract --clean`
3. **Translate** - Fill `msgstr` fields in `.po` files
4. **Compile** - `bun run i18n:compile`
5. **Runtime** - App loads compiled `.ts` files

## Adding a New Language

### Step 1: Update lingui.config.ts

```typescript
export default defineConfig({
  sourceLocale: 'en',
  locales: ['en', 'zh-CN', 'zh-TW', 'ja', 'ko', 'es'], // Add new locale
  // ...
});
```

### Step 2: Extract

```bash
bun run i18n:extract
```

This creates the new locale directory with a PO file.

### Step 3: Translate

Translate all messages in `src/locales/es/messages.po`.

### Step 4: Compile

```bash
bun run i18n:compile
```

### Step 5: Update Available Languages

Update `/src/i18n/config.ts`:

```typescript
export const availableLanguages = ['en', 'zh-CN', 'zh-TW', 'ja', 'ko', 'es'];
```

### Add RTL Support (if applicable)

If the language is RTL, add it to the `rtlLanguages` array in `config.ts`:

```typescript
const rtlLanguages = ['he', 'fa', 'ur', 'ar'];
```

## RTL Language Support

### Automatic Direction Switching

The i18n config automatically updates `document.documentElement.dir` when the language changes:

```typescript
// In /src/i18n/config.ts
function onLocaleChange(locale: string) {
  const dir = rtlLanguages.includes(locale) ? 'rtl' : 'ltr';
  document.documentElement.dir = dir;
  document.documentElement.lang = locale;
}
```

RTL languages automatically:

- Set `dir="rtl"` on HTML element
- Update CSS logical properties support via Tailwind
- Flip layout direction

### CSS Logical Properties

Use logical properties instead of physical ones:

| Physical (avoid) | Logical (use)                         |
| ---------------- | ------------------------------------- |
| `left`           | `start` or `inset-inline-start`       |
| `right`          | `end` or `inset-inline-end`           |
| `margin-left`    | `margin-inline-start` or `ms-*`       |
| `margin-right`   | `margin-inline-end` or `me-*`         |
| `padding-left`   | `padding-inline-start` or `ps-*`      |
| `padding-right`  | `padding-inline-end` or `pe-*`        |
| `text-left`      | `text-start`                          |
| `text-right`     | `text-end`                            |
| `border-left`    | `border-s-*` or `border-inline-start` |
| `border-right`   | `border-e-*` or `border-inline-end`   |

### Example

```tsx
// ❌ BAD: Physical properties break in RTL
<div className="text-left pl-4 mr-2">

// ✅ GOOD: Logical properties work in both LTR and RTL
<div className="text-start ps-4 me-2">
```

## System Locale Detection

On app startup, the language is initialized based on:

1. **User's saved preference** (if set in preferences)
2. **System locale** (if we have translations for it)
3. **English** (fallback)

See `/src/i18n/language-init.ts` for the implementation.

## Language Selector

The language selector in Preferences > Appearance allows users to change the language:

```typescript
import { availableLanguages, loadAndActivate } from '@/i18n/config';

function LanguageSelector() {
  const handleChange = async (lang: string) => {
    await loadAndActivate(lang);
    // Save to preferences...
  };

  return (
    <Select value={currentLanguage} onValueChange={handleChange}>
      {availableLanguages.map(lang => (
        <SelectItem key={lang} value={lang}>
          {lang.toUpperCase()}
        </SelectItem>
      ))}
    </Select>
  );
}
```

## Key Naming Conventions

Lingui uses **source text** as keys, not pre-defined IDs. Translation keys in PO files are generated automatically.

### Example Translation

```typescript
// Component code
_(msg`Save Changes`)
```

```po
# messages.po
msgid "Save Changes"
msgstr "保存更改"
```

### Key Generation

| Source Text                     | PO msgid                     |
| ------------------------------- | ---------------------------- |
| `_(msg`Save Changes`)`          | `Save Changes`               |
| `_(msg`About ${appName}`)`      | `About {appName}`            |

## ICU MessageFormat Reference

Lingui uses ICU MessageFormat for advanced formatting features.

### Variables

```typescript
_(msg`Hello ${name}`)
```

### Plurals

```typescript
plural(count, {
  one: '# item',
  other: '# items',
})
```

### Select

```typescript
select(gender, {
  male: 'He',
  female: 'She',
  other: 'They',
})
```

### Ordinals

```typescript
ordinal(position, {
  one: '#st',
  two: '#nd',
  few: '#rd',
  other: '#th',
})
```

## Test File Limitations

Bun's test runner doesn't process Lingui macros. Use helper functions in test files:

```typescript
// Test files ONLY
import type { MessageDescriptor } from '@lingui/core';

const createMsgDescriptor = (text: string): MessageDescriptor => ({
  id: text,
  message: text,
});

// Use in tests
const mockCommand: AppCommand = {
  id: 'test-command',
  label: createMsgDescriptor('Test Command'), // ✅ Works in tests
  // label: msg`Test Command`,                // ❌ Breaks in Bun tests
};
```

## Best Practices

### ✅ DO

1. **Use msg macro everywhere**:
   ```typescript
   const text = msg`Hello world`;
   ```

2. **Extract regularly**:
   ```bash
   bun run i18n:extract --clean
   ```

3. **Use descriptive messages**:
   ```typescript
   // ✅ Good - clear context
   const title = msg`User Profile Settings`;

   // ❌ Bad - vague
   const title = msg`Settings`;
   ```

4. **Use variables for dynamic content**:
   ```typescript
   const greeting = msg`Hello ${userName}`;
   ```

5. **Use source text as keys**: `_(msg`Save Changes`)` is better than string IDs
6. **Translate before compiling**: Ensure all PO files are translated before `bun run i18n:compile`
7. **Use ICU MessageFormat**: Leverage pluralization, select, and other features
8. **Keep messages complete**: Translators need full context in the source text
9. **Use logical properties**: Always use `text-start`, `ps-*`, `me-*` etc. for RTL support

### ❌ DON'T

1. **Don't use string keys**:
   ```typescript
   // ❌ Bad
   t("user.profile.title");

   // ✅ Good
   _(msg`User Profile`);
   ```

2. **Don't use msg macro in test files**:
   ```typescript
   // ❌ Breaks with Bun
   label: msg`Test`,

   // ✅ Works in tests
   label: createMsgDescriptor('Test'),
   ```

3. **Don't bypass extraction**:
   ```typescript
   // ❌ Bad - won't be extracted
   const text = "Hello world";

   // ✅ Good - will be extracted
   const text = msg`Hello world`;
   ```

4. **Don't hand-edit .po files** - use extract/compile cycle

## Testing with RTL

To test RTL layout:

1. Open Preferences > Appearance
2. Change language to an RTL language (e.g., Hebrew, Persian, Urdu, Arabic)
3. Verify layout mirrors correctly
4. Check all text alignment uses logical properties

## Troubleshooting

### Messages Not Appearing

1. Did you run `bun run i18n:extract`?
2. Did you run `bun run i18n:compile`?
3. Check console for message extraction warnings

### Missing Translations

1. Check `bun run i18n:extract` output for "Missing" counts
2. Translate strings in the PO file
3. Run `bun run i18n:compile`

### RTL Not Working

1. Check language is in `rtlLanguages` array in `config.ts`
2. Verify `document.documentElement.dir` updates
3. Use CSS logical properties (`text-start`, not `text-left`)

## Why Lingui?

### Advantages

- **Compile-time extraction** - Messages extracted at build time, no runtime overhead
- **Type-safe** - No string key typos, direct macro usage
- **ICU MessageFormat** - Built-in pluralization, select, and ordinal support
- **SWC compiler** - Fast compilation without Babel
- **PO file format** - Standard gettext format, translator-friendly
- **Small bundle** - Minimal runtime footprint

## References

- [Lingui Documentation](https://lingui.dev)
- [ICU MessageFormat](https://unicode-org.github.io/icu/userguide/format_parse/messages/)
- [gettext PO Format](https://www.gnu.org/software/gettext/manual/html_node/PO-Files.html)
